name: "Build integration"

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        architecture: ["aarch64", "x86_64"]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # History of 500 should be more than enough to calculate commit count for dev builds
          fetch-depth: 500

      - name: Get version
        run: |
          if [[ "${{ github.ref }}" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "RELEASE=true" >> $GITHUB_ENV
            echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          else
            echo "RELEASE=false" >> $GITHUB_ENV
            echo "VERSION=0.0.0+$(git rev-list --count HEAD)" >> $GITHUB_ENV
          fi

      - name: Show version
        run: echo "Building version ${{ env.VERSION }}, release=${{ env.RELEASE }}"

      - name: Build integration
        run: |
          # Create build directory structure
          mkdir -p build/uc-intg-smartthings

          # Copy all necessary files maintaining flat structure required by UC Remote
          cp -r uc_intg_smartthings build/uc-intg-smartthings/
          cp driver.json build/uc-intg-smartthings/
          cp requirements.txt build/uc-intg-smartthings/

          # Generate version file
          cat > build/uc-intg-smartthings/uc_intg_smartthings/_version.py << EOF
          # File generated during build
          __version__ = "${{ env.VERSION }}"
          version = "${{ env.VERSION }}"
          __version_tuple__ = tuple(map(int, "${{ env.VERSION }}".split('+')[0].split('.')))
          version_tuple = __version_tuple__
          EOF

          # Update driver.json with correct version
          sed -i 's/"version": "1.0.0"/"version": "${{ env.VERSION }}"/' build/uc-intg-smartthings/driver.json

          # Create the tarball with UC Remote compatible structure
          cd build
          tar -czf uc-intg-smartthings-${{ env.VERSION }}-${{ matrix.architecture }}.tar.gz uc-intg-smartthings/
          cd ..

          # Move tarball to root for upload
          mv build/uc-intg-smartthings-${{ env.VERSION }}-${{ matrix.architecture }}.tar.gz .

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: uc-intg-smartthings-${{ env.VERSION }}-${{ matrix.architecture }}
          path: uc-intg-smartthings-${{ env.VERSION }}-${{ matrix.architecture }}.tar.gz
          retention-days: 30

  release:
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true

      - name: Get version for release
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: uc-intg-smartthings-${{ env.VERSION }}-*.tar.gz
          tag_name: v${{ env.VERSION }}
          name: SmartThings Integration v${{ env.VERSION }}
          body: |
            # SmartThings Integration v${{ env.VERSION }}
            
            ## Features
            - Complete SmartThings device support (Lights, Switches, Locks, Sensors, Climate, Covers, Media Players)
            - Optimistic updates for instant response
            - Smart polling with adaptive intervals
            - Lock control via switch interface (ON=Locked, OFF=Unlocked)
            - Robust error handling and API management
            
            ## Installation
            1. Download the appropriate `.tar.gz` file for your Remote architecture
            2. Upload via Remote web interface: Settings → Integrations → Add Integration
            3. Generate SmartThings Personal Access Token at: https://account.smartthings.com/tokens
            4. Follow setup wizard to configure devices
            
            ## What's New in v${{ env.VERSION }}
            - See [CHANGELOG.md](https://github.com/mase1981/uc-intg-smartthings/blob/main/CHANGELOG.md) for detailed changes
            
            ## Architecture Support
            - `aarch64`: Unfolded Circle Remote 2/3 (ARM64)  
            - `x86_64`: Docker/Development environments
            
            ## Support
            - [Documentation](https://github.com/mase1981/uc-intg-smartthings/blob/main/README.md)
            - [Issues & Bug Reports](https://github.com/mase1981/uc-intg-smartthings/issues)
            - [Community Forum](https://unfolded.community/)
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}